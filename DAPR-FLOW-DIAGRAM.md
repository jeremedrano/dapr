# Diagrama de Flujo DAPR - Comunicaciรณn entre Microservicios

## ๐ Flujo Simplificado de Comunicaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                    CLIENTE EXTERNO                                           โ
โ                                                                                             โ
โ  ๐ Cliente HTTP (Postman, curl, navegador, etc.)                                          โ
โ                                                                                             โ
โ  ๐ก Request: GET http://localhost:8088/users/pokemon                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                              ๐ค USER-APP SERVICE (Puerto 8088)                              โ
โ                                                                                             โ
โ  ๐ฏ UserResource.getRandomPokemon()                                                        โ
โ  ๐ pokemonClientService.getRandomPokemon()                                                โ
โ  ๐ง PokemonClient.getRandomPokemon()                                                       โ
โ                                                                                             โ
โ  ๐ป Cรณdigo Java:                                                                           โ
โ     daprClient.invokeMethod("pokemon-service", "pokemon/random", ...)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Puerto 3502)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ๐ง DAPR SIDECAR (User-App) - Puerto 3502                            โ
โ                                                                                             โ
โ  ๐ฅ Recibe request del User-App Service                                                   โ
โ  ๐ Service Discovery: Busca "pokemon-service"                                            โ
โ  ๐ก Envรญa request al DAPR Runtime                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Puerto 3500)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           ๐ DAPR RUNTIME - Puerto 3500                                    โ
โ                                                                                             โ
โ  ๐ Service Registry:                                                                      โ
โ     โข pokemon-service โ localhost:3501                                                    โ
โ     โข user-app-service โ localhost:3502                                                   โ
โ                                                                                             โ
โ  ๐ Encuentra pokemon-service en el registry                                              โ
โ  ๐ก Redirige request al sidecar correcto                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Puerto 3501)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ๐ง DAPR SIDECAR (Pokemon) - Puerto 3501                             โ
โ                                                                                             โ
โ  ๐ฅ Recibe request del DAPR Runtime                                                        โ
โ  ๐ Load Balancing (si hay mรบltiples instancias)                                          โ
โ  ๐ก๏ธ Circuit Breaker (protecciรณn contra fallos)                                           โ
โ  ๐ Retry Logic (reintentos automรกticos)                                                  โ
โ  ๐ก Envรญa request al Pokemon Service                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Puerto 8086)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                            ๐ฎ POKEMON SERVICE (Puerto 8086)                                โ
โ                                                                                             โ
โ  ๐ฏ PokemonResource.getRandomPokemon()                                                    โ
โ  ๐ pokemonService.getRandomPokemon()                                                     โ
โ  ๐ pokemonRepository.getRandomPokemon()                                                  โ
โ                                                                                             โ
โ  ๐ป Cรณdigo Java:                                                                           โ
โ     // Lรณgica de negocio y acceso a datos                                                 โ
โ     return pokemonRepository.getRandomPokemon();                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Response JSON)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค Response: {"id":25,"name":"Pikachu","type":"Electric","level":5,"abilities":[...]}     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ
                                        โผ (Flujo de Respuesta)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                              ๐ FLUJO DE RESPUESTA (REVERSO)                               โ
โ                                                                                             โ
โ  Pokemon Service (8086) โ DAPR Sidecar (3501) โ DAPR Runtime (3500) โ                      โ
โ  DAPR Sidecar (3502) โ User-App Service (8088) โ Cliente Externo                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Mapa de Puertos Detallado

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                    MAPA DE PUERTOS DAPR                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ DAPR RUNTIME (GLOBAL)                                                                   โ
โ                                                                                             โ
โ  ๐ก Puerto HTTP: 3500                                                                       โ
โ  ๐ก Puerto gRPC: 50001                                                                      โ
โ                                                                                             โ
โ  ๐ Service Registry:                                                                       โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ     โ  ๐ REGISTRO DE SERVICIOS                                                           โ โ
โ     โ                                                                                     โ โ
โ     โ  ๐ฎ pokemon-service                                                                 โ โ
โ     โ     โโโ App ID: "pokemon-service"                                                   โ โ
โ     โ     โโโ Sidecar HTTP: localhost:3501                                                โ โ
โ     โ     โโโ Sidecar gRPC: localhost:50002                                               โ โ
โ     โ     โโโ App Port: localhost:8086                                                    โ โ
โ     โ                                                                                     โ โ
โ     โ  ๐ค user-app-service                                                                โ โ
โ     โ     โโโ App ID: "user-app-service"                                                  โ โ
โ     โ     โโโ Sidecar HTTP: localhost:3502                                                โ โ
โ     โ     โโโ Sidecar gRPC: localhost:50003                                               โ โ
โ     โ     โโโ App Port: localhost:8088                                                    โ โ
โ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฎ POKEMON SERVICE CONTAINER                                                               โ
โ                                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  ๐ง DAPR SIDECAR (Pokemon)                                                              โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ก Puerto HTTP: 3501                                                                   โ โ
โ  โ  ๐ก Puerto gRPC: 50002                                                                  โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ Comunicaciรณn:                                                                       โ โ
โ  โ     โข โ DAPR Runtime (3500)                                                            โ โ
โ  โ     โข โ Pokemon Service (8086)                                                         โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  ๐ฎ POKEMON SERVICE (Quarkus)                                                           โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ก Puerto HTTP: 8086                                                                   โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ Comunicaciรณn:                                                                       โ โ
โ  โ     โข โ DAPR Sidecar (3501)                                                            โ โ
โ  โ     โข โ Cliente Directo (para testing)                                                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ค USER-APP SERVICE CONTAINER                                                              โ
โ                                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  ๐ง DAPR SIDECAR (User-App)                                                             โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ก Puerto HTTP: 3502                                                                   โ โ
โ  โ  ๐ก Puerto gRPC: 50003                                                                  โ โ
โ  โ                                                                                         โ โ
โ  โ  ๐ Comunicaciรณn:                                                                       โ โ โ
โ  โ     โข โ User-App Service (8088)                                                        โ โ โ
โ  โ     โข โ DAPR Runtime (3500)                                                            โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ                                                                                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  ๐ค USER-APP SERVICE (Quarkus)                                                          โ โ โ
โ  โ                                                                                         โ โ โ
โ  โ  ๐ก Puerto HTTP: 8088                                                                   โ โ โ
โ  โ                                                                                         โ โ โ
โ  โ  ๐ Comunicaciรณn:                                                                       โ โ โ
โ  โ     โข โ Cliente Externo                                                                โ โ โ
โ  โ     โข โ DAPR Sidecar (3502)                                                            โ โ โ
โ  โ                                                                                         โ โ โ
โ  โ  ๐ป PokemonClient.java:                                                                โ โ โ
โ  โ     System.setProperty("DAPR_HTTP_PORT", "3502");                                      โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ๐ OBSERVABILITY                                                                           โ โ
โ                                                                                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  ๐ ZIPKIN TRACING                                                                       โ โ โ
โ  โ                                                                                         โ โ โ
โ  โ  ๐ก Puerto: 9411                                                                        โ โ โ
โ  โ  ๐ Endpoint: http://localhost:9411/api/v2/spans                                        โ โ โ
โ  โ                                                                                         โ โ โ
โ  โ  ๐ Recibe traces de:                                                                   โ โ โ
โ  โ     โข DAPR Sidecar (Pokemon) - 3501                                                    โ โ โ
โ  โ     โข DAPR Sidecar (User-App) - 3502                                                   โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ง Configuraciรณn en Cรณdigo

### 1. PokemonClient.java
```java
// Configuraciรณn del puerto DAPR
private static final String DAPR_HTTP_PORT = "3502"; // Puerto DAPR del User-App Service

// En el constructor
System.setProperty("DAPR_HTTP_PORT", DAPR_HTTP_PORT);
this.daprClient = new DaprClientBuilder().build();
```

### 2. start-services.ps1
```powershell
# DAPR Runtime Global
dapr run --app-id dapr-runtime --dapr-http-port 3500 --dapr-grpc-port 50001

# Pokemon Service
dapr run --app-id pokemon-service --app-port 8086 --dapr-http-port 3501 --dapr-grpc-port 50002

# User-App Service  
dapr run --app-id user-app-service --app-port 8088 --dapr-http-port 3502 --dapr-grpc-port 50003
```

### 3. dapr-pokemon.yaml
```yaml
metadata:
- name: app-id
  value: pokemon-service
- name: app-port
  value: "8086"
```

### 4. dapr-user-app.yaml
```yaml
metadata:
- name: app-id
  value: user-app-service
- name: app-port
  value: "8088"
```

## ๐ฏ Puntos Clave de la Arquitectura

### 1. **Service Discovery Automรกtico**
- DAPR Runtime mantiene un registry de todos los servicios
- Los sidecars se registran automรกticamente al iniciar
- La comunicaciรณn se hace por App ID, no por IP/puerto

### 2. **Sidecar Pattern**
- Cada microservicio tiene su propio sidecar DAPR
- El sidecar maneja toda la comunicaciรณn externa
- La aplicaciรณn no necesita conocer detalles de red

### 3. **Resiliencia Automรกtica**
- Circuit Breaker: Protege contra fallos en cascada
- Retry Logic: Reintentos automรกticos en fallos
- Load Balancing: Distribuye requests automรกticamente

### 4. **Observabilidad**
- Tracing automรกtico con Zipkin
- Mรฉtricas de performance
- Logs estructurados

## ๐ Comandos de Prueba

```bash
# 1. Test directo al Pokemon Service
curl http://localhost:8086/pokemon/random

# 2. Test User-App Service (que usa DAPR internamente)
curl http://localhost:8088/users/pokemon

# 3. Test de comunicaciรณn entre servicios
curl http://localhost:8088/users/pokemon/25

# 4. Test de saludo del servicio
curl http://localhost:8088/users/pokemon-service/hello
```

## ๐ Debugging de Puertos

```bash
# Verificar puertos en uso
netstat -an | findstr "8086\|8088\|3500\|3501\|3502\|9411"

# Verificar servicios DAPR
dapr list

# Verificar logs de DAPR
dapr logs --app-id pokemon-service
dapr logs --app-id user-app-service
``` 