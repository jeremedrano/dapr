# Diagrama de Arquitectura DAPR - Microservicios Pokemon

## ๐ Diagrama de Puertos y Sidecars

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                    ARQUITECTURA DAPR COMPLETA                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                                    DESARROLLO LOCAL (localhost)                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฎ POKEMON SERVICE (Microservicio 1)                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                           POKEMON SERVICE CONTAINER                                        โ โ
โ  โ                                                                                             โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ                    ๐ฎ POKEMON SERVICE (Quarkus)                                        โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ก Puerto de Aplicaciรณn: 8086                                                        โ โ โ
โ  โ  โ  ๐ Endpoints REST:                                                                    โ โ โ
โ  โ  โ     โข GET /pokemon/random                                                              โ โ โ
โ  โ  โ     โข GET /pokemon/{id}                                                                โ โ โ
โ  โ  โ     โข GET /pokemon/list                                                                โ โ โ
โ  โ  โ     โข GET /pokemon/hello                                                               โ โ โ
โ  โ  โ     โข POST /pokemon                                                                    โ โ โ
โ  โ  โ     โข PUT /pokemon/{id}                                                                โ โ โ
โ  โ  โ     โข DELETE /pokemon/{id}                                                             โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ Comunicaciรณn: Solo recibe requests HTTP                                           โ โ โ
โ  โ  โ  ๐ App ID: "pokemon-service"                                                          โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ                                                                                             โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ                    ๐ง DAPR SIDECAR (Pokemon)                                          โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ก Puerto HTTP DAPR: 3501                                                            โ โ โ
โ  โ  โ  ๐ก Puerto gRPC DAPR: 50002                                                           โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ Service Discovery:                                                                โ โ โ
โ  โ  โ     โข Registra "pokemon-service" en el registry                                       โ โ โ
โ  โ  โ     โข Expone endpoints para service invocation                                        โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ Funcionalidades:                                                                   โ โ โ
โ  โ  โ     โข Service Invocation (enabled)                                                    โ โ โ
โ  โ  โ     โข Observability (tracing)                                                         โ โ โ
โ  โ  โ     โข CORS handling                                                                    โ โ โ
โ  โ  โ     โข Load Balancing (automรกtico)                                                     โ โ โ
โ  โ  โ     โข Circuit Breaker (automรกtico)                                                    โ โ โ
โ  โ  โ     โข Retry Logic (automรกtico)                                                        โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                           ๐ COMUNICACIรN INTER-SERVICIOS                                  โ โ โ
โ  โ                                                                                             โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ                    ๐ DAPR SERVICE INVOCATION                                          โ โ โ
โ  โ  โ                                                                                         โ โ โ
โ  โ  โ  ๐ก Protocolo: HTTP                                                                    โ โ โ
โ  โ  โ  ๐ Service Discovery: Automรกtico por App ID                                          โ โ โ
โ  โ  โ  โก Load Balancing: Automรกtico                                                         โ โ โ
โ  โ  โ  ๐ Retry Logic: Automรกtico                                                            โ โ โ
โ  โ  โ  ๐ก๏ธ Circuit Breaker: Automรกtico                                                       โ โ โ
โ  โ  โ  ๐ Tracing: Automรกtico (Zipkin en puerto 9411)                                       โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  ๐ค USER-APP SERVICE (Microservicio 2)                                                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โ
โ  โ                                                                                             โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ โ
โ  โ  โ                    ๐ง DAPR SIDECAR (User-App)                                         โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ก Puerto HTTP DAPR: 3502                                                            โ โ โ โ
โ  โ  โ  ๐ก Puerto gRPC DAPR: 50003                                                           โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ Service Discovery:                                                                โ โ โ โ
โ  โ  โ     โข Registra "user-app-service" en el registry                                      โ โ โ โ
โ  โ  โ     โข Conecta con "pokemon-service" via service invocation                            โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ Funcionalidades:                                                                   โ โ โ โ
โ  โ  โ     โข Service Invocation (enabled)                                                    โ โ โ โ
โ  โ  โ     โข Observability (tracing)                                                         โ โ โ โ
โ  โ  โ     โข CORS handling                                                                    โ โ โ โ
โ  โ  โ     โข Load Balancing (automรกtico)                                                     โ โ โ โ
โ  โ  โ     โข Circuit Breaker (automรกtico)                                                    โ โ โ โ
โ  โ  โ     โข Retry Logic (automรกtico)                                                        โ โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ โ
โ  โ  โ                    ๐ค USER-APP SERVICE (Quarkus)                                      โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ก Puerto de Aplicaciรณn: 8088                                                        โ โ โ โ
โ  โ  โ  ๐ Endpoints REST:                                                                    โ โ โ โ
โ  โ  โ     โข GET /users/hello                                                                 โ โ โ โ
โ  โ  โ     โข GET /users                                                                       โ โ โ โ
โ  โ  โ     โข GET /users/{id}                                                                  โ โ โ โ
โ  โ  โ     โข POST /users                                                                      โ โ โ โ
โ  โ  โ     โข PUT /users/{id}                                                                  โ โ โ โ
โ  โ  โ     โข DELETE /users/{id}                                                               โ โ โ โ
โ  โ  โ     โข GET /users/pokemon                                                               โ โ โ โ
โ  โ  โ     โข GET /users/pokemon/{id}                                                          โ โ โ โ
โ  โ  โ     โข GET /users/pokemon/list                                                          โ โ โ โ
โ  โ  โ     โข GET /users/pokemon-service/hello                                                 โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ Comunicaciรณn:                                                                      โ โ โ โ
โ  โ  โ     โข Recibe requests HTTP externos                                                   โ โ โ โ
โ  โ  โ     โข Envรญa requests a Pokemon Service via DAPR                                       โ โ โ โ
โ  โ  โ                                                                                         โ โ โ โ
โ  โ  โ  ๐ App ID: "user-app-service"                                                         โ โ โ โ
โ  โ  โ  ๐ง PokemonClient: Conecta a DAPR sidecar en puerto 3502                              โ โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ                                                                                                 โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ๐ DAPR RUNTIME (Global)                                                                      โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โ
โ                                                                                                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ                    ๐ DAPR RUNTIME                                                        โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  ๐ก Puerto HTTP DAPR: 3500                                                                โ โ โ
โ  โ  ๐ก Puerto gRPC DAPR: 50001                                                               โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  ๐ Service Registry:                                                                      โ โ โ
โ  โ     โข Registra todos los servicios                                                        โ โ โ
โ  โ     โข Maneja service discovery                                                            โ โ โ
โ  โ     โข Coordina comunicaciรณn entre sidecars                                               โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  ๐ Funcionalidades Globales:                                                             โ โ โ
โ  โ     โข Service Discovery                                                                   โ โ โ
โ  โ     โข Load Balancing                                                                      โ โ โ
โ  โ     โข Health Checking                                                                     โ โ โ
โ  โ     โข Metrics Collection                                                                  โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ๐ OBSERVABILITY (Zipkin)                                                                     โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โ
โ                                                                                                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ                    ๐ ZIPKIN TRACING                                                       โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  ๐ก Puerto: 9411                                                                           โ โ โ
โ  โ  ๐ Endpoint: http://localhost:9411/api/v2/spans                                          โ โ โ
โ  โ                                                                                             โ โ โ
โ  โ  ๐ Funcionalidades:                                                                       โ โ โ
โ  โ     โข Distributed Tracing                                                                  โ โ โ
โ  โ     โข Request Flow Visualization                                                          โ โ โ
โ  โ     โข Performance Monitoring                                                               โ โ โ
โ  โ     โข Error Tracking                                                                       โ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

```

## ๐ Flujo de Comunicaciรณn Detallado

### 1. Request Externo โ User-App Service

```
Cliente HTTP โ Puerto 8088 โ User-App Service (Quarkus)
```

### 2. User-App Service โ DAPR Sidecar (Local)

```
User-App Service โ Puerto 3502 โ DAPR Sidecar (User-App)
```

### 3. DAPR Sidecar โ Service Discovery

```
DAPR Sidecar (User-App) โ DAPR Runtime (Puerto 3500) โ Service Registry
```

### 4. Service Discovery โ Pokemon Service

```
DAPR Runtime โ DAPR Sidecar (Pokemon) โ Puerto 8086 โ Pokemon Service
```

### 5. Response Flow (Reverso)

```
Pokemon Service โ DAPR Sidecar (Pokemon) โ DAPR Runtime โ DAPR Sidecar (User-App) โ User-App Service โ Cliente
```

## ๐ Resumen de Puertos

| Componente | Puerto HTTP | Puerto gRPC | Descripciรณn |
|------------|-------------|-------------|-------------|
| **DAPR Runtime** | 3500 | 50001 | Runtime global de DAPR |
| **Pokemon Service** | 8086 | - | Aplicaciรณn Quarkus Pokemon |
| **DAPR Sidecar (Pokemon)** | 3501 | 50002 | Sidecar del Pokemon Service |
| **User-App Service** | 8088 | - | Aplicaciรณn Quarkus User-App |
| **DAPR Sidecar (User-App)** | 3502 | 50003 | Sidecar del User-App Service |
| **Zipkin Tracing** | 9411 | - | Observabilidad y tracing |

## ๐ง Configuraciรณn de Puertos en Cรณdigo

### PokemonClient.java
```java
private static final String DAPR_HTTP_PORT = "3502"; // Puerto DAPR del User-App Service
```

### start-services.ps1
```powershell
# DAPR Runtime
--dapr-http-port 3500 --dapr-grpc-port 50001

# Pokemon Service
--app-port 8086 --dapr-http-port 3501 --dapr-grpc-port 50002

# User-App Service  
--app-port 8088 --dapr-http-port 3502 --dapr-grpc-port 50003
```

## ๐ฏ Beneficios de esta Arquitectura

1. **Service Discovery Automรกtico**: DAPR encuentra servicios por App ID
2. **Load Balancing**: Distribuye requests automรกticamente
3. **Circuit Breaker**: Protege contra fallos en cascada
4. **Retry Logic**: Reintentos automรกticos en fallos
5. **Observabilidad**: Tracing completo de requests
6. **Resiliencia**: Manejo automรกtico de errores
7. **Escalabilidad**: Fรกcil agregar mรกs instancias

## ๐ Comandos de Inicio

```powershell
# Iniciar DAPR Runtime
dapr run --app-id dapr-runtime --dapr-http-port 3500 --dapr-grpc-port 50001

# Iniciar Pokemon Service
dapr run --app-id pokemon-service --app-port 8086 --dapr-http-port 3501 --dapr-grpc-port 50002 -- cd code-user-pokemon/code-user-pokemon && ./gradlew quarkusDev

# Iniciar User-App Service
dapr run --app-id user-app-service --app-port 8088 --dapr-http-port 3502 --dapr-grpc-port 50003 -- cd code-user-app/code-user-app && ./gradlew quarkusDev
```

## ๐ Endpoints de Prueba

```bash
# Test Pokemon Service directamente
curl http://localhost:8086/pokemon/random
curl http://localhost:8086/pokemon/25

# Test User-App Service (que usa DAPR)
curl http://localhost:8088/users/pokemon
curl http://localhost:8088/users/pokemon/25
curl http://localhost:8088/users/pokemon-service/hello
``` 